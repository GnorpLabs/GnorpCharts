apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ include "recyclarr.fullname" . }}
  namespace: {{ .Values.namespace }}
spec:
  schedule: {{ .Values.schedule }}
  successfulJobsHistoryLimit: {{ .Values.successfulJobsHistoryLimit }}
  failedJobsHistoryLimit: {{ .Values.failedJobsHistoryLimit }}
  concurrencyPolicy: {{ .Values.concurrencyPolicy }}
  jobTemplate:
    spec:
      backoffLimit: {{ .Values.backoffLimit }}
      template:
        spec:
          securityContext:
          {{- toYaml .Values.securityContext | nindent 12 }}
          containers:
            - name: {{ .Chart.Name }}
              image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}"
              imagePullPolicy: {{ .Values.image.pullPolicy }}
              args: [ {{ .Values.args | quote }} ] 
              env:
                {{- toYaml .Values.config.env | nindent 16 }}
              resources:
                {{- toYaml .Values.resources | nindent 16 }}
              volumeMounts:
                - name: config
                  mountPath: /config
              {{- if .Values.config.configMap.enabled }}
                - name: recyclarr-config
                  mountPath: /config/recyclarr.yaml
                  subPath: {{.Values.config.configMap.config.subPath}}
              {{- end }}
              {{- if .Values.volumeMounts -}}
                {{- toYaml .Values.volumeMounts | nindent 12 }}
              {{- end }}
          volumes:
            - name: config
              persistentVolumeClaim:
                {{- if .Values.persistence.config.claimName }}
                claimName: "{{ .Values.persistence.config.claimName }}"
                {{- else }}
                claimName: "{{ template "recyclarr.fullname" . }}-config"
                {{- end }}
            {{- if .Values.config.configMap.enabled }}
            - configMap:
                name: {{ .Values.config.configmap.config.name }}
              name: {{ .Values.config.configmap.config.name }}
            {{- end }}
          {{- if .Values.volumes -}}
            {{- toYaml .Values.volumes | nindent 12 }}
          {{- end }}

          restartPolicy: {{ .Values.restartPolicy }}